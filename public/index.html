<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <title>US Map with State-wise Heatmap</title>
</head>
<body>

    <script>
    const width = 975;
    const height = 610;

    const svg = d3.create("svg")
        .attr("width", width)
        .attr("height", height);

    document.body.appendChild(svg.node());
    

      d3.json("10m.json").then(us => {
        
        fetch('/api/us')
            .then(response => response.json())
            .then(databaseData => {
                const heatmapData = processData(databaseData, us);

                const colorScale = d3.scaleSequential(d3.interpolateBlues)
                    .domain([0, d3.max(Array.from(heatmapData.values()))]);

                const path = d3.geoPath();

                svg.selectAll("path")
                    .data(topojson.feature(us, us.objects.states).features)
                    .enter().append("path")
                    .attr("d", path)
                    .attr("stroke", "white")
                    .attr("stroke-width", 0.5)
                    .attr("fill", d => colorScale(heatmapData.get(d.id) || 0));
            })
            .catch(error => console.error('Error fetching data:', error));

        function processData(databaseData, us) {
            const data = new Map();
            let statesum = {}

            for (const item of databaseData) {
               // const stateId = item.state_id;
               let state = item.state_province
                if (state in statesum){
                    statesum[state]+=1;
               } else {
                    statesum[state]=1;
               }
               // data.set(stateId, item.value);
            }
            console.log(statesum);
            console.log(us);

            return data;
        }
    })
    .catch(error => console.error('Error fetching TopoJSON data:', error));
    </script>

</body>
</html>